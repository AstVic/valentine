<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
<title>ананас❤️</title>

<style>
html, body {
  margin: 0;
  padding: 0;
  background: white;
  overflow: hidden;
  height: 100%;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
}

#stage {
  position: fixed;
  inset: 0;
  will-change: transform;
}

canvas { display: block; }

.text {
  position: absolute;
  top: 8%;
  width: 100%;
  text-align: center;
  font-size: clamp(28px, 6vw, 48px);
  color: #ff4d6d;
  letter-spacing: 1px;
  user-select: none;
  text-shadow: 0 0 12px rgba(255, 77, 109, 0.8);
  pointer-events: none;
  z-index: 5;
}

.start {
  position: absolute;
  inset: 0;
  display: grid;
  place-items: center;
  background: rgba(255,255,255,0.75);
  backdrop-filter: blur(6px);
  z-index: 10;
}

.start button {
  border: none;
  border-radius: 999px;
  padding: 14px 18px;
  font-size: 18px;
  cursor: pointer;
  background: #ff4d6d;
  color: white;
  box-shadow: 0 10px 30px rgba(255, 77, 109, 0.35);
}

/* Контейнер круга */
#videoCircle {
  position: absolute;
  left: 50%;
  top: 50%;
  width: 40px;
  height: 40px;
  transform: translate(-50%, -50%);
  border-radius: 50%;
  overflow: hidden;
  z-index: 6;
  opacity: 0;
}

/* Само видео */
#flyVideo {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

/* Flash */
#flash {
  position: fixed;
  inset: 0;
  background: white;
  opacity: 0;
  pointer-events: none;
  z-index: 20;
}
</style>
</head>

<body>
<div id="stage">
  <div class="text">ананас❤️</div>

  <div class="start" id="startOverlay">
    <button id="startBtn">Нажми, чтобы начать ❤️</button>
  </div>

  <canvas id="canvas"></canvas>

  <div id="videoCircle">
    <video id="flyVideo" playsinline muted loop preload="auto">
      <source src="./sticker.webm" type="video/webm">
    </video>
  </div>
</div>

<div id="flash"></div>

<script>
const stage = document.getElementById("stage");
const flash = document.getElementById("flash");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const videoCircle = document.getElementById("videoCircle");
const flyVideo = document.getElementById("flyVideo");

function resize() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}
window.addEventListener("resize", resize);
resize();

/* Сердце */
function heart(t) {
  return {
    x: 16 * Math.sin(t) ** 3,
    y: 13 * Math.cos(t) - 5 * Math.cos(2*t) - 2 * Math.cos(3*t) - Math.cos(4*t)
  };
}

function drawBigHeart() {
  const pulse = 1 + Math.sin(performance.now() * 0.002) * 0.04;
  const scale = Math.min(canvas.width, canvas.height) / 40 * pulse;

  ctx.save();
  ctx.translate(canvas.width/2, canvas.height/2);
  ctx.fillStyle = "#ff4d6d";
  ctx.beginPath();
  for (let t = 0; t < Math.PI * 2; t += 0.01) {
    const { x, y } = heart(t);
    ctx.lineTo(x * scale, -y * scale);
  }
  ctx.closePath();
  ctx.fill();
  ctx.restore();
}

/* Маленькие сердечки — 3 секунды */
let smallHearts = [];
function spawnSmallHeart(startMs) {
  if (performance.now() - startMs < 3000) {
    const angle = Math.random() * Math.PI * 2;
    const speed = 1.2 + Math.random() * 2.0;
    smallHearts.push({
      x: canvas.width / 2,
      y: canvas.height / 2,
      vx: Math.cos(angle) * speed,
      vy: Math.sin(angle) * speed,
      size: 5 + Math.random() * 3,
      color: `hsl(${Math.random() * 360}, 100%, 65%)`
    });
  }
}

function drawSmallHearts() {
  for (let i = smallHearts.length - 1; i >= 0; i--) {
    const h = smallHearts[i];
    ctx.fillStyle = h.color;

    ctx.beginPath();
    ctx.moveTo(h.x, h.y - h.size/2);
    ctx.bezierCurveTo(h.x - h.size, h.y - h.size*1.5,
                      h.x - h.size*2, h.y + h.size/3,
                      h.x, h.y + h.size);
    ctx.bezierCurveTo(h.x + h.size*2, h.y + h.size/3,
                      h.x + h.size, h.y - h.size*1.5,
                      h.x, h.y - h.size/2);
    ctx.fill();

    h.x += h.vx;
    h.y += h.vy;
    h.vy += 0.02;

    if (h.y - h.size > canvas.height ||
        h.x + h.size < 0 ||
        h.x - h.size > canvas.width) {
      smallHearts.splice(i, 1);
    }
  }
}

/* Звук */
const audio = new Audio("./mobileringtone.online_never-gonna-give-you-up.mp3");
audio.loop = true;

const QUIET_VOL = 0.03;
const LOUD_VOL = 0.95;

/* Тряска */
let shakeMode = "off";
let hitUntil = 0;

function applyShake() {
  if (shakeMode === "off") {
    stage.style.transform = "translate(0,0)";
    return;
  }

  const k = (shakeMode === "hit") ? 26 : 12;
  const dx = (Math.random() * 2 - 1) * k;
  const dy = (Math.random() * 2 - 1) * k;

  stage.style.transform = `translate(${dx}px, ${dy}px)`;

  if (shakeMode === "hit" && performance.now() >= hitUntil) {
    shakeMode = "on";
  }
}

/* Flash */
function doFlash() {
  flash.style.opacity = "1";
  setTimeout(() => flash.style.opacity = "0", 120);
}

/* Видео анимация */
let videoAnim = null;

function startVideoFlight() {
  videoCircle.style.opacity = "1";

  const minSide = Math.min(canvas.width, canvas.height);
  const targetPx = minSide * 0.46;

  videoAnim = {
    size: 40,
    target: targetPx,
    growth: 1.18
  };
}

function updateVideoFlight() {
  if (!videoAnim) return;

  if (videoAnim.size < videoAnim.target) {
    videoAnim.size = Math.min(
      videoAnim.target,
      videoAnim.size * videoAnim.growth
    );
  }

  videoCircle.style.width = `${videoAnim.size}px`;
  videoCircle.style.height = `${videoAnim.size}px`;
}

/* Micro freeze */
let freezeUntil = 0;
function doFreeze(ms) {
  freezeUntil = performance.now() + ms;
}

/* LOOP */
let startMs = null;
let running = false;
let dropped = false;

function tick() {
  if (!running) return;

  if (performance.now() < freezeUntil) {
    applyShake();
    requestAnimationFrame(tick);
    return;
  }

  ctx.clearRect(0, 0, canvas.width, canvas.height);

  drawBigHeart();
  spawnSmallHeart(startMs);
  drawSmallHearts();

  const elapsed = performance.now() - startMs;

  if (!dropped && elapsed >= 3000) {
    dropped = true;

    audio.volume = LOUD_VOL;
    doFlash();
    doFreeze(90);

    shakeMode = "hit";
    hitUntil = performance.now() + 180;

    startVideoFlight();
  }

  updateVideoFlight();
  applyShake();

  requestAnimationFrame(tick);
}

document.getElementById("startBtn").addEventListener("click", async () => {
  document.getElementById("startOverlay").style.display = "none";

  startMs = performance.now();
  running = true;

  audio.volume = QUIET_VOL;

  await audio.play().catch(()=>{});
  await flyVideo.play().catch(()=>{});

  tick();
});
</script>
</body>
</html>
