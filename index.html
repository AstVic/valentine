<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
<title>ананас❤️</title>

<style>
  html, body {
    margin: 0;
    padding: 0;
    background: white;
    overflow: hidden;
    height: 100%;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  }

  #stage {
    position: fixed;
    inset: 0;
    will-change: transform;
  }

  canvas { display: block; }

  .text {
    position: absolute;
    top: 8%;
    width: 100%;
    text-align: center;
    font-size: clamp(28px, 6vw, 48px);
    color: #ff4d6d;
    letter-spacing: 1px;
    user-select: none;
    text-shadow: 0 0 12px rgba(255, 77, 109, 0.8);
    pointer-events: none;
    z-index: 5;
  }

  .start {
    position: absolute;
    inset: 0;
    display: grid;
    place-items: center;
    background: rgba(255,255,255,0.75);
    backdrop-filter: blur(6px);
    z-index: 10;
  }

  .start button {
    border: none;
    border-radius: 999px;
    padding: 14px 18px;
    font-size: 18px;
    cursor: pointer;
    background: #ff4d6d;
    color: white;
    box-shadow: 0 10px 30px rgba(255, 77, 109, 0.35);
  }

  #flyVideo {
    position: absolute;
    left: 50%;
    top: 50%;
    width: 40px;
    height: 40px;
    transform: translate(-50%, -50%);
    transform-origin: center center;
    z-index: 6;
    opacity: 0;
    pointer-events: none;
  }

  /* Flash overlay */
  #flash {
    position: fixed;
    inset: 0;
    background: white;
    opacity: 0;
    pointer-events: none;
    z-index: 20;
  }
</style>
</head>

<body>
<div id="stage">
  <div class="text">ананас❤️</div>

  <div class="start" id="startOverlay">
    <button id="startBtn">Нажми, чтобы начать ❤️</button>
  </div>

  <canvas id="canvas"></canvas>

  <video id="flyVideo" playsinline muted loop preload="auto">
    <source src="./sticker.webm" type="video/webm">
  </video>
</div>

<div id="flash"></div>

<script>
const stage = document.getElementById("stage");
const flash = document.getElementById("flash");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const flyVideo = document.getElementById("flyVideo");

function resize() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}
window.addEventListener("resize", resize);
resize();

// сердце
function heart(t) {
  return {
    x: 16 * Math.sin(t) ** 3,
    y: 13 * Math.cos(t) - 5 * Math.cos(2*t) - 2 * Math.cos(3*t) - Math.cos(4*t)
  };
}

function drawBigHeart() {
  const pulse = 1 + Math.sin(performance.now() * 0.002) * 0.04;
  const scale = Math.min(canvas.width, canvas.height) / 40 * pulse;

  ctx.save();
  ctx.translate(canvas.width/2, canvas.height/2);
  ctx.fillStyle = "#ff4d6d";
  ctx.beginPath();
  for (let t = 0; t < Math.PI * 2; t += 0.01) {
    const { x, y } = heart(t);
    ctx.lineTo(x * scale, -y * scale);
  }
  ctx.closePath();
  ctx.fill();
  ctx.restore();
}

// маленькие сердечки (3 сек)
let smallHearts = [];
function spawnSmallHeart(startMs) {
  if (performance.now() - startMs < 3000) {
    const angle = Math.random() * Math.PI * 2;
    const speed = 1.2 + Math.random() * 2.0;
    smallHearts.push({
      x: canvas.width / 2,
      y: canvas.height / 2,
      vx: Math.cos(angle) * speed,
      vy: Math.sin(angle) * speed,
      size: 5 + Math.random() * 3,
      color: `hsl(${Math.random() * 360}, 100%, 65%)`
    });
  }
}

function drawSmallHearts() {
  for (let i = smallHearts.length - 1; i >= 0; i--) {
    const h = smallHearts[i];
    ctx.fillStyle = h.color;

    ctx.beginPath();
    ctx.moveTo(h.x, h.y - h.size/2);
    ctx.bezierCurveTo(h.x - h.size, h.y - h.size*1.5, h.x - h.size*2, h.y + h.size/3, h.x, h.y + h.size);
    ctx.bezierCurveTo(h.x + h.size*2, h.y + h.size/3, h.x + h.size, h.y - h.size*1.5, h.x, h.y - h.size/2);
    ctx.fill();

    h.x += h.vx;
    h.y += h.vy;
    h.vy += 0.02;

    if (h.y - h.size > canvas.height || h.x + h.size < 0 || h.x - h.size > canvas.width) {
      smallHearts.splice(i, 1);
    }
  }
}

// звук
const audio = new Audio("./mobileringtone.online_never-gonna-give-you-up.mp3");
audio.loop = true;

const QUIET_VOL = 0.03; // супер тихо
const LOUD_VOL  = 0.95; // супер громко

// тряска
let shakeMode = "off"; // off | hit | on
let hitUntil = 0;

function applyShake() {
  if (shakeMode === "off") {
    stage.style.transform = "translate(0px, 0px)";
    return;
  }

  // HIT — мощный удар, потом обычная бесконечная
  const k = (shakeMode === "hit") ? 26 : 12;

  const dx = (Math.random() * 2 - 1) * k;
  const dy = (Math.random() * 2 - 1) * k;
  stage.style.transform = `translate(${dx}px, ${dy}px)`;

  if (shakeMode === "hit" && performance.now() >= hitUntil) {
    shakeMode = "on";
  }
}

// flash
function doFlash() {
  flash.style.opacity = "1";
  setTimeout(() => { flash.style.opacity = "0"; }, 120);
}

// видео: вылет вверх + рост
let videoAnim = null;

function startVideoFlight() {
  flyVideo.style.opacity = "1";

  const targetSize = Math.min(canvas.width, canvas.height) * 0.6;

  videoAnim = {
    x: canvas.width / 2,
    y: canvas.height / 2,
    size: 40,
    target: targetSize,
    growth: 1.18,
    settled: false
  };
}

function updateVideoFlight() {
  if (!videoAnim) return;

  // увеличиваем размер
  if (videoAnim.size < videoAnim.target) {
    videoAnim.size = Math.min(
      videoAnim.target,
      videoAnim.size * videoAnim.growth
    );
  } else {
    videoAnim.settled = true;
  }

  // всегда фиксируем строго в центре
  flyVideo.style.left = "50%";
  flyVideo.style.top = "50%";
  flyVideo.style.width = `${videoAnim.size}px`;
  flyVideo.style.height = `${videoAnim.size}px`;
  flyVideo.style.transform = "translate(-50%, -50%)";
}

// micro-freeze (stop-frame)
let freezeUntil = 0;
function doFreeze(ms) {
  freezeUntil = performance.now() + ms;
}

// loop
let startMs = null;
let running = false;
let dropped = false;

function tick() {
  if (!running) return;

  // micro-freeze: не обновляем сцену, но тряску и flash можно оставить
  if (performance.now() < freezeUntil) {
    applyShake();
    requestAnimationFrame(tick);
    return;
  }

  ctx.clearRect(0, 0, canvas.width, canvas.height);

  drawBigHeart();
  spawnSmallHeart(startMs);
  drawSmallHearts();

  const elapsed = performance.now() - startMs;

  if (!dropped && elapsed >= 3000) {
    dropped = true;

    // BASS DROP
    audio.volume = LOUD_VOL;   // резкий скачок громкости
    doFlash();                 // flash
    doFreeze(90);              // микрозаморозка кадра

    shakeMode = "hit";         // сильная тряска
    hitUntil = performance.now() + 180;

    startVideoFlight();
  }

  updateVideoFlight();
  applyShake();

  requestAnimationFrame(tick);
}

document.getElementById("startBtn").addEventListener("click", async () => {
  document.getElementById("startOverlay").style.display = "none";

  startMs = performance.now();
  running = true;

  audio.volume = QUIET_VOL;
  await audio.play().catch(()=>{});
  await flyVideo.play().catch(()=>{});

  tick();
});
</script>
</body>
</html>
